#!/bin/bash
#
# Pre-commit hook for Transire
# This hook runs the same checks as the CI pipeline to catch issues early
#
# To install: Run `./scripts/install-hooks.sh`
# To bypass: Use `git commit --no-verify`

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Track if any check fails
CHECKS_PASSED=true

# Helper functions
print_step() {
    echo -e "${BLUE}==> $1${NC}"
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_error() {
    echo -e "${RED}✗ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

# Check if we're in the right directory
if [ ! -f "go.mod" ]; then
    print_error "go.mod not found. Are you in the repository root?"
    exit 1
fi

echo ""
print_step "Running pre-commit checks..."
echo ""

# 1. Check formatting
print_step "Checking code formatting..."
UNFORMATTED=$(gofmt -l . | grep -v "node_modules/" | grep -v "vendor/" | grep -v ".template.go" || true)
if [ -n "$UNFORMATTED" ]; then
    print_error "Code formatting check failed"
    echo "The following files need formatting:"
    echo "$UNFORMATTED"
    echo ""
    echo "Run: gofmt -w ."
    CHECKS_PASSED=false
else
    print_success "Code formatting check passed"
fi
echo ""

# 2. Run go vet
print_step "Running go vet..."
if go vet ./... 2>&1; then
    print_success "go vet passed"
else
    print_error "go vet failed"
    CHECKS_PASSED=false
fi
echo ""

# 3. Run golangci-lint (if available)
print_step "Running golangci-lint..."
if command -v golangci-lint &> /dev/null; then
    if golangci-lint run --timeout=3m 2>&1; then
        print_success "golangci-lint passed"
    else
        print_error "golangci-lint failed"
        CHECKS_PASSED=false
    fi
else
    print_warning "golangci-lint not found (optional but recommended)"
    echo "Install: curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b \$(go env GOPATH)/bin"
fi
echo ""

# 4. Run tests
print_step "Running tests..."
if go test -race -timeout=2m ./... 2>&1; then
    print_success "Tests passed"
else
    print_error "Tests failed"
    CHECKS_PASSED=false
fi
echo ""

# 5. Build CLI
print_step "Building CLI..."
if go build -o /tmp/transire-cli-test cmd/transire/main.go 2>&1; then
    rm -f /tmp/transire-cli-test
    print_success "CLI build passed"
else
    print_error "CLI build failed"
    CHECKS_PASSED=false
fi
echo ""

# Final result
if [ "$CHECKS_PASSED" = true ]; then
    echo -e "${GREEN}╔════════════════════════════════════════╗${NC}"
    echo -e "${GREEN}║   ✓ All pre-commit checks passed!    ║${NC}"
    echo -e "${GREEN}╚════════════════════════════════════════╝${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}╔════════════════════════════════════════╗${NC}"
    echo -e "${RED}║   ✗ Pre-commit checks failed!        ║${NC}"
    echo -e "${RED}╚════════════════════════════════════════╝${NC}"
    echo ""
    echo "Fix the issues above before committing."
    echo "To bypass this hook (not recommended): git commit --no-verify"
    echo ""
    exit 1
fi
